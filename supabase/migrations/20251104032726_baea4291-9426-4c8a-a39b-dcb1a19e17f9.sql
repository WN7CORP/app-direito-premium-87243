-- Criar tabela CPPM com estrutura id√™ntica ao C√≥digo Penal
CREATE TABLE "CPPM ‚Äì C√≥digo de Processo Penal Militar" (
  id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "Artigo" text,
  "N√∫mero do Artigo" text,
  "Narra√ß√£o" text,
  "Comentario" text,
  "Aula" text,
  explicacao_tecnico text,
  explicacao_resumido text,
  explicacao_simples_menor16 text,
  explicacao_simples_maior16 text,
  exemplo text,
  versao_conteudo integer DEFAULT 1,
  termos jsonb,
  flashcards jsonb,
  questoes jsonb,
  ultima_atualizacao timestamp without time zone,
  termos_aprofundados jsonb DEFAULT '{}'::jsonb,
  visualizacoes integer DEFAULT 0,
  ultima_visualizacao timestamp with time zone
);

-- Habilitar RLS
ALTER TABLE "CPPM ‚Äì C√≥digo de Processo Penal Militar" ENABLE ROW LEVEL SECURITY;

-- Policy para leitura p√∫blica
CREATE POLICY "CPPM √© p√∫blico para leitura"
  ON "CPPM ‚Äì C√≥digo de Processo Penal Militar"
  FOR SELECT
  USING (true);

-- Policy para atualiza√ß√£o pelo sistema
CREATE POLICY "Sistema pode atualizar CPPM"
  ON "CPPM ‚Äì C√≥digo de Processo Penal Militar"
  FOR UPDATE
  USING (true);

-- Transferir todos os dados da TABELA PARA EDITAR (756 registros)
INSERT INTO "CPPM ‚Äì C√≥digo de Processo Penal Militar" ("Artigo", "N√∫mero do Artigo")
SELECT 
  "Artigo",
  "N√∫mero do Artigo"
FROM "TABELA PARA EDITAR"
ORDER BY id;

-- Valida√ß√£o
DO $$
DECLARE
  total_records integer;
  total_artigos integer;
BEGIN
  SELECT COUNT(*) INTO total_records FROM "CPPM ‚Äì C√≥digo de Processo Penal Militar";
  SELECT COUNT(*) INTO total_artigos FROM "CPPM ‚Äì C√≥digo de Processo Penal Militar" WHERE "N√∫mero do Artigo" IS NOT NULL;
  
  RAISE NOTICE '‚úÖ Tabela CPPM criada com sucesso!';
  RAISE NOTICE 'üìä Total de registros: %', total_records;
  RAISE NOTICE 'üìÑ Artigos numerados: %', total_artigos;
  RAISE NOTICE 'üèõÔ∏è Estruturas (t√≠tulos/cabe√ßalhos): %', total_records - total_artigos;
END $$;